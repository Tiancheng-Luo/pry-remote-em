#!/usr/bin/env ruby

$: << File.expand_path("../../lib", __FILE__)

require 'uri'
require 'highline'
require 'pry-remote-em/client'

uri = ARGV[0] || "pryem://localhost:#{PryRemoteEm::DEFPORT}"
uri = URI.parse(uri)
unless %w(pryem pryems).include?(uri.scheme)
  abort "only pryem URIs are currently supported\n usage: pryem(s)://127.0.0.1:#{PryRemoteEm::DEFPORT}" 
end

tried = 0
auth_proc = proc do
  tried += 1
  user   = uri.user || Readline.readline("user: ")
  pass   = (!uri.password.nil? && tried <= 1) ? uri.password : HighLine.new.ask("#{user}'s password: ") { |q| q.echo = '*'}  
  [user, pass]
end

EM.run do
  PryRemoteEm::Client.start(uri.host, uri.port, :auth=>auth_proc, :tls=>uri.scheme=='pryems') { |e| EM.stop }
end
